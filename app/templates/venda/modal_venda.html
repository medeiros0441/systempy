{% load static%}

{% block content %}
    <div class="modal fade" id="ModalVenda" data-bs-backdrop="static"   data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog  modal-md modal-fullscreen-md-down modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold font-monospace" id="ModalLabel" >Detalhes de Venda</h5>
                </div>
                <div class="modal-body  font-monospace" id="container-detalhes">


                    <div class=" my-1 font-monospace row d-flex card">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex align-items-center font-monospace">
                                <span class="me-auto fs-6 text-white text-center">Detalhes da venda</span>
                            </div>  
                        </div>
                            <div class="  card-body  ">
                                <div>
                                    <i class="bi bi-shop"></i>
                                    <span><strong>Loja:</strong></span>
                                    <span id="detalhes_loja_venda" class="font-monospace"></span>
                                </div>
                                
                                
                                <div>
                                    <i class="bi bi-calendar"></i>
                                    <span><strong>Data:</strong></span>
                                    <span id="detalhes_data_venda" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-clock"></i>
                                    <span><strong>Horário:</strong></span>
                                    <span id="detalhes_horario_venda" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-arrow-clockwise"></i>
                                    <span><strong>Atualização:</strong></span>
                                    <span id="detalhes_atualizacao" class="font-monospace"></span>
                                </div>
                                
                                <div>
                                    <i class="bi bi-cash"></i>
                                    <span><strong>Forma de Pagamento:</strong></span>
                                    <span id="detalhes_forma_pagamento" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-credit-card"></i>
                                    <span><strong>Estado da Transação:</strong></span>
                                    <span id="detalhes_estado_transacao" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-truck"></i>
                                    <span><strong>Método de Entrega:</strong></span>
                                    <span id="detalhes_metodo_entrega" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-percent"></i>
                                    <span><strong>Desconto:</strong></span>
                                    <span id="detalhes_desconto" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-cash-stack"></i>
                                    <span><strong>Valor Total:</strong></span>
                                    <span id="detalhes_valor_total" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-currency-dollar"></i>
                                    <span><strong>Valor da Entrega:</strong></span>
                                    <span id="detalhes_valor_entrega" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-cash-coin"></i>
                                    <span><strong>Valor Pago:</strong></span>
                                    <span id="detalhes_valor_pago" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-cash"></i>
                                    <span><strong>Troco:</strong></span>
                                    <span id="detalhes_troco" class="font-monospace"></span>
                                </div>
                                <div>
                                    <i class="bi bi-card-text"></i>
                                    <span><strong>Descrição:</strong></span>
                                    <span id="detalhes_descricao" class="font-monospace"></span>
                                </div>
                            </div>
                        </div>
 
        <!--card carrinho de produtos -->
        <div class=" my-1 font-monospace row d-flex card">
        <div class="card-header bg-dark text-white">
        <div class="d-flex align-items-center font-monospace">
        <span class="me-auto fs-6 text-white text-center">produtos</span>
        </div>  </div>
        <div class="  card-body ">

        <ul class="list-group" id="ul_produtos">

        </ul>
        </div>
        </div>
 
    <div class="card mb-2 d-none  row"  id="info_motoboy" >
        <div class="card-header bg-dark text-white">
            <div class="d-flex align-items-center font-monospace">
                <span class="me-auto fs-6 text-white">Responsavel pela  entrega</span>
            </div>
        </div>
        <div class="card-body ">
                    <label class="  fw-bold"  >Nome Motoboy:</label>
                    <span class="" id="nome_motoboy" ></span>
                    <br/>
                    <label class="fw-bold" >Telefone Motoboy:</label>
                    <span class="" id="telefone_motoboy" > </span>
        </div>
    </div>
<!--card detalhes do cliente  -->

                    <div   class=" font-monospace row d-flex card">
                        <div class="card-header bg-dark text-white" id="">
                            <div class="d-flex align-items-center font-monospace">
                                <span class="me-auto fs-6 text-white text-center">Informações do Cliente</span>
                            </div> 
                         </div>
                            <div id="informativo_not_cliente" class="d-none card-body">
                                <div class="text-center">
                                <p class="font-monospace   fw-bold">Não há cliente associado à venda.</p>
                            </div>
                            <div class="text-center">
                                <img src="/assents/img/undraw/undraw_faq_re_31cw.svg" class="img-fluid col-10" style="max-width: 300px; max-height: 300px;">
                            </div>
                        </div>
                        <div   id="details-cliente" class="d-none">
                            
                            <div  class="  card-body row d-flex"  >
                            <div class="col-auto d-inline-flex">
                                <i class="bi bi-person-fill me-1"></i>
                                <span class="fw-bold">Nome: </span>
                                <span id="info_nome_cliente"></span>
                            </div>
                            <div class="col-auto d-inline-flex">
                                <i class="bi bi-phone-fill me-1"></i>
                                <span class="fw-bold">Telefone: </span>
                                <span id="info_telefone_cliente"></span>
                            </div>
                            <div class="col-auto d-inline-flex">
                                <i class="bi bi-people-fill me-1"></i>
                                <span class="fw-bold">Tipo de Cliente: </span>
                                <span id="info_tipo_cliente"></span>
                            </div>
                            <div class=" mb-1 ">
                                <i class="bi bi-info-circle me-1"></i>
                                <span class="fw-bold">Descrição: </span>
                                <span id="info_descricao_cliente"></span>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="  card-body row d-flex">
                            <h5 class="mb-1 text-center" style="font:size 0.5rem">Informações de Endereço</h5>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                <span class="fw-bold">Código Postal: </span>
                                <span id="info_codigo_postal"></span>
                            </div>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-house-fill me-1"></i>
                                <span class="fw-bold">Rua: </span>
                                <span id="info_rua"></span>
                            </div>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                <span class="fw-bold">Número: </span>
                                <span id="info_numero"></span>
                            </div>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                <span class="fw-bold">Bairro: </span>
                                <span id="info_bairro"></span>
                            </div>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                <span class="fw-bold">Cidade: </span>
                                <span id="info_cidade"></span>
                            </div>
                            <div class="col-sm-6 d-inline-flex">
                                <i class="bi bi-flag-fill me-2"></i>
                                <span class="fw-bold">Estado: </span>
                                <span id="info_estado"></span>
                            </div>
                            <div class=" mb-1 ">
                                <i class="bi bi-info-circle me-1"></i>
                                <span class="fw-bold">Descrição: </span>
                                <span id="info_descricao_endereco"></span>
                            </div>
                        </div>
                       
                    </div> 
                </div>
                     
                 
<div class=" my-1 font-monospace row d-flex card">
    <div class="card-header bg-dark text-white">
    <div class="d-flex align-items-center font-monospace">
    <span class="me-auto fs-6 text-white text-center">Produtos retornáveis </span>
    </div>  </div>

    <div id="informativo_not_retonaveis" class="d-none card-body">
        <div class="text-center">
        <p class="font-monospace  fw-bold">Não há produtos retonaveis nessa venda.</p>
    </div>
    <div class="text-center">
        <img src="/assents/img/undraw/undraw_faq_re_31cw.svg" class="img-fluid col-10" style="max-width: 300px; max-height: 300px;">
        </div>
        </div>
    <div id="details-retonaveis" class="  card-body ">

    </div>
            </div>
        </div>
             <script>


function montarInfoCliente(data, id_container) {
    var container = document.getElementById(id_container);
    // Atualizar os valores dos campos com os dados fornecidos
    container.querySelector("#info_nome_cliente").textContent = data.nome;
    container.querySelector("#info_telefone_cliente").textContent = data.telefone;
    container.querySelector("#info_tipo_cliente").textContent = data.tipo_cliente;
    container.querySelector("#info_descricao_cliente").textContent = data.descricao;
    container.querySelector("#info_codigo_postal").textContent = data.codigo_postal;
    container.querySelector("#info_rua").textContent = data.rua;
    container.querySelector("#info_numero").textContent = data.numero;
    container.querySelector("#info_bairro").textContent = data.bairro;
    container.querySelector("#info_cidade").textContent = data.cidade;
    container.querySelector("#info_estado").textContent = data.estado;
    container.querySelector("#info_descricao_endereco").textContent = data.descricao_endereco;
    container.classList.remove("d-none");
}
 function close_cliente(){
    document.getElementById('id_cliente').value = "0";
    document.getElementById('info_cliente').classList.add("d-none")
    toggleResultadoPesquisa(true);
    alertCustomer(`Cliente Retirado de Selecão`);
 }

function detalhes_modal_cliente(id_venda) {
    var data_vendas = Utils.getLocalStorageItem("data_vendas");
    var venda_selecionada = {};
    // Encontra a venda selecionada
    data_vendas.forEach(function(item) {
        if (item.id_venda === id_venda) {
            venda_selecionada = item;
        }
    });
    atualizarDetalhesTransacao(venda_selecionada);
    select_motoboy(venda_selecionada.id_venda)
    // Chama a API para obter os produtos da venda
    manageLoading(true,"ul_produtos");
    chamarFuncaoPython("/api/produtos/by/venda/" + id_venda, {}, "GET", function(response) {
        // Verifica se a resposta foi bem-sucedida
        if (response.success === true) {
            // Obtém a lista de produtos da resposta
            var produtos = response.list_produtos;
            var ul_produtos = document.getElementById("ul_produtos");
            ul_produtos.innerHTML = ""
            // Itera sobre os produtos e os exibe
            produtos.forEach(function(valor) {
                var ul_produtos = document.getElementById("ul_produtos");
                var novoItemLista = document.createElement("li");
                novoItemLista.classList.add("list-group-item", "item-list-carrinho","bg-dark","text-white", "d-flex", "justify-content-between", "align-items-center");
                novoItemLista.innerHTML = `
                    <span class="badge text-bg-primary me-1 rounded-pill quantidade">${valor.quantidade}</span>
                    <span class="text-small small" style="font-size: 0.8rem;">${valor.nome} R$ ${valor.preco_venda} Unid</span>
                `;
                ul_produtos.appendChild(novoItemLista);
            });
        }
        else {
            alertCustomer(response.message);
        }
         
        manageLoading(false,"ul_produtos");
    });
    chamarFuncaoPython("/api/cliente/by/venda/" + id_venda, {}, "GET", function(response) {
        if (response.success === true) {
            document.getElementById("informativo_not_cliente").classList.add("d-none");
            montarInfoCliente(response.cliente,"details-cliente");
            document.getElementById("details-cliente").classList.remove("d-none");

        } else {
            document.getElementById("informativo_not_cliente").classList.remove("d-none");
            document.getElementById("details-cliente").classList.add("d-none");
        }
    });



    function select_motoboy(id_venda) {
        chamarFuncaoPython('/get_motoboy_by_venda/'+id_venda, null, 'GET', function(response) {
            if (response.motoboy) {
                    document.getElementById('info_motoboy').classList.remove("d-none");
                    document.getElementById('nome_motoboy').innerText = response.motoboy.nome;
                    document.getElementById('telefone_motoboy').innerText = response.motoboy.telefone;
            }
        });
    }
    // Função para formatar números em moeda
    function formatarMoeda(valor) {
        // Converte o valor para um número decimal
        const valorDecimal = parseFloat(valor);
    
        // Verifica se o valorDecimal é um número
        if (!isNaN(valorDecimal)) {
            // Se for um número, formata para moeda e retorna
            return "R$ " + valorDecimal.toFixed(2);
        } else {
            // Se não for um número, retorna "N/A"
            return "N/A";
        }
    }

        // Função para atualizar os detalhes da transação com base nos dados recebidos
    function atualizarDetalhesTransacao(data) {
        manageLoading(true,"details-cliente");
        document.getElementById("detalhes_forma_pagamento").textContent = data.forma_pagamento;
        document.getElementById("detalhes_estado_transacao").textContent = data.estado_transacao;
        document.getElementById("detalhes_metodo_entrega").textContent = data.metodo_entrega;
        document.getElementById("detalhes_desconto").textContent = formatarMoeda(data.desconto);
        document.getElementById("detalhes_valor_total").textContent = formatarMoeda(data.valor_total);
        document.getElementById("detalhes_valor_entrega").textContent = formatarMoeda(data.valor_entrega);
        document.getElementById("detalhes_valor_pago").textContent = formatarMoeda(data.valor_pago);
        document.getElementById("detalhes_troco").textContent = formatarMoeda(data.troco);
        document.getElementById("detalhes_descricao").textContent = data.descricao;
        // Imprimir os dados nos spans correspondentes
        const dataVendaFormatada = formatarDataHora(data.insert);
        const dataAtualizacaoFormatada = formatarDataHora(data.update);
    
        document.getElementById("detalhes_data_venda").textContent = dataVendaFormatada.data;
        document.getElementById("detalhes_horario_venda").textContent = dataVendaFormatada.hora;
        document.getElementById("detalhes_atualizacao").textContent = verificarAtualizacao(data.insert, data.update);

        var data_lojas = Utils.getLocalStorageItem("data_lojas");
        // Encontra a venda selecionada
        data_lojas.forEach(function(item) {
            if (item.id_loja === data.loja_id) {
                document.getElementById("detalhes_loja_venda").textContent = item.nome_loja;
            }
        });
        manageLoading(false,"details-cliente");

    }
     
    function formatarDataHora(dataStr) {
        const [dia, mes, anoHora] = dataStr.split('/');
        const [ano, hora] = anoHora.split(' ');
        return {
            data: `${dia}/${mes}/${ano}`,
            hora: hora
        };
    }
    
    function verificarAtualizacao(dataVenda, dataAtualizacao) {
        if (dataVenda === dataAtualizacao) {
            return "Não foi alterado";
        } else {
            return dataAtualizacao;
        }
    }
    manageLoading(true,"details-retonaveis");
    
    chamarFuncaoPython("/api/retornaveis/by/venda/" + id_venda, {}, "GET", function(response) {
        if (response.success === true) {
            if(response.list_retornaveis.length >0){
                document.getElementById("details-retonaveis").classList.remove("d-none");
                document.getElementById("informativo_not_retonaveis").classList.add("d-none");
            ProdutosRetornaveis(response.list_retornaveis);
            }else{
                document.getElementById("informativo_not_retonaveis").classList.remove("d-none");
                document.getElementById("details-retonaveis").classList.add("d-none");
            }

        } else {
            alertCustomer(response.message);
        }
        manageLoading(false,"details-retonaveis");
    });
    function ProdutosRetornaveis(data_list) {
        const container = document.getElementById('details-retonaveis');
    
        for (let i = 0; i < data_list.length; i++) {
            const galaoEntrando = data_list[i];
    
            // Preencher os campos para o galão que está entrando
            const divEntrada = document.createElement('div');
            divEntrada.classList.add('border-dark', 'border', 'rounded', 'bg-success', 'p-2', 'm-0', 'text-dark', 'bg-opacity-25', 'mb-1');
            divEntrada.innerHTML = `
            <label class="form-label  fw-bold col-12 mx-atuo text-center  mb-1">Galão que entrou ${i + 1}.</label>
                <div class="col mx-1 p-0">
                        <span class="bi bi-calendar"></span>
                        <label class="form-label m-0 fw-bold">Data de Validade:</label>
                        <span class="ml-1">${galaoEntrando.validade_entrada}</span>
                    </div>
                <div class="col mx-1 p-0">
                        <span class="bi bi-calendar"></span>
                        <label class="form-label m-0 fw-bold">Data de Fabricação:</label>
                        <span class="ml-1">${galaoEntrando.fabricacao_entrada}</span>
                </div>
            <div class="col">
                <span class="bi bi-sign-in"></span>
                <label class="form-label m-0 fw-bold">Tipo de entrada:</label>
                <span class="ml-1">${galaoEntrando.tipo_entrada}</span>
            </div>
            `;
            container.appendChild(divEntrada);
    
            const galaoSaindo = data_list[i];
    
            // Preencher os campos para o galão que está saindo
            const divSaida = document.createElement('div');
            divSaida.classList.add('border-dark', 'border', 'rounded', 'bg-danger', 'p-2', 'm-0', 'text-dark', 'bg-opacity-25', 'mb-2');
            divSaida.innerHTML = `
                        
                    <label class="form-label  fw-bold col-12 mx-atuo text-center mb-1">Galão que saiu ${i + 1}.</label>
                        <div class="col mx-1 p-0">
                                <span class="bi bi-calendar"></span>
                                <label class="form-label m-0 fw-bold">Data de Validade:</label>
                                <span class="ml-1">${galaoSaindo.validade_saida}</span>
                        </div>
                        <div class="col mx-1 p-0">
                                <span class="bi bi-calendar"></span>
                                <label class="form-label m-0 fw-bold">Data de Fabricação:</label>
                                <span class="ml-1">${galaoSaindo.fabricacao_saida}</span>
                        </div>
                    </div>
                    <div class="col">
                        <span class="bi bi-sign-out"></span>
                        <label class="form-label m-0 fw-bold">Tipo de saída:</label>
                        <span class="ml-1">${galaoSaindo.tipo_saida}</span>
                    </div>
                    <div class="col">
                        <span class="bi bi-info-circle"></span>
                        <label class="form-label m-0 fw-bold">Descrição:</label>
                        <span class="ml-1">${galaoSaindo.descricao_gestao || 'Nenhuma descrição disponível'}</span>
                    </div>
            `;
            container.appendChild(divSaida);
        }
    }
    
}
</script>

                <div class="modal-footer ">
                        <button type="button" onclick="close_modal();"  class="btn btn-secondary float-start ms-auto btn-sm">Fechar</a>
                </div>  
        </form>
    </div> 
 
    </div>
    </div>
    </div>


{% endblock %}
